<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>yeobi-easy for KOR</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        /* Pretendard CDN */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        /* SUIT CDN */
        @import url('https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css');
        
        :root {
            --font-suit: 'SUIT', sans-serif;
            --font-pretendard: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            --color-teal: #00BFA5;
            --color-bg-card: #F7F9FB;
            --color-text-main: #191F28;
        }

        body { 
            font-family: var(--font-pretendard);
            background-color: #FFFFFF;
            color: var(--color-text-main);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .input-group {
            transition: all 0.2s ease;
            border: 1px solid #E5E8EB;
        }
        .input-group:focus-within {
            border-color: var(--color-teal);
            box-shadow: 0 0 0 4px rgba(0, 191, 165, 0.1);
        }

        .btn-primary {
            background-color: var(--color-teal);
            color: white;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary:active {
            transform: scale(0.98);
            background-color: #00A891;
        }

        /* Animations */
        @keyframes pulse-attention {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(0, 191, 165, 0.2); }
            50% { transform: scale(1.03); box-shadow: 0 0 0 4px rgba(0, 191, 165, 0.15); }
        }
        .animate-pulse-attention { 
            animation: pulse-attention 2.5s infinite cubic-bezier(0.4, 0, 0.2, 1); 
        }

        /* Flip Effects */
        .perspective-1000 { perspective: 1000px; }
        .flip-card-inner { transition: transform 0.6s; transform-style: preserve-3d; position: relative; width: 100%; height: 100%; }
        .is-flipped { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { 
            backface-visibility: hidden; 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            top: 0; 
            left: 0; 
            border-radius: 20px;
            background-color: var(--color-bg-card);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .flip-card-back { transform: rotateY(180deg); overflow-y: auto; background-color: #fff; border: 2px solid rgba(0, 191, 165, 0.1); }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #E5E8EB; border-radius: 4px; }
        
        input.ship-fare-input {
            text-align: right; border-bottom: 1px solid #E5E8EB; background-color: transparent;
            width: 80px; font-family: var(--font-suit); font-weight: 700; outline: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 2026년 기준 설정 ---
        const CONFIG = {
            OUT_DAILY: 25000,
            OUT_MEAL: 25000,
            IN_DAILY_LONG: 20000,
            IN_DAILY_SHORT: 10000,
            BUS_RATE: 168.6,
            BASE_FARE: 1800
        };

        const FERRY_DB = { "흑산": 20550, "하의": 5930, "신의": 5930, "비금": 10500, "도초": 10500, "청산": 3850, "노화": 3850, "조도": 5000 };

        // --- 유틸리티 ---
        const CHOSUNG = ["ㄱ","ㄲ","ㄴ","ㄷ","ㄸ","ㄹ","ㅁ","ㅂ","ㅃ","ㅅ","ㅆ","ㅇ","ㅈ","ㅉ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
        const getChosung = (str) => {
            let result = "";
            for (let i = 0; i < str.length; i++) {
                const code = str.charCodeAt(i) - 44032;
                if (code > -1 && code < 11172) result += CHOSUNG[Math.floor(code / 588)];
                else result += str.charAt(i);
            }
            return result;
        };

        const Icons = {
            MapPin: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
        };

        const AutocompleteInput = ({ label, value, onChange, onSelect, list, placeholder }) => {
            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);

            useEffect(() => {
                const inputVal = (value || '').trim();
                if (!inputVal) { setSuggestions([]); return; }
                if (list.includes(inputVal)) { setSuggestions([]); return; }

                const inputCho = getChosung(inputVal);
                const filtered = list.filter(item => {
                    return item.includes(inputVal) || getChosung(item).includes(inputCho);
                }).slice(0, 8);

                setSuggestions(filtered);
            }, [value, list]);

            return (
                <div className="relative group z-20">
                    <div className="input-group bg-white rounded-2xl p-4 flex items-center gap-3 shadow-sm">
                        <Icons.MapPin />
                        <div className="flex-1">
                            <label className="block text-[10px] font-bold text-gray-400 mb-1 font-pretendard">{label}</label>
                            <input
                                type="text"
                                className="w-full bg-transparent outline-none font-suit font-bold text-gray-800 text-lg placeholder-gray-300"
                                placeholder={placeholder}
                                value={value}
                                onChange={e => { onChange(e.target.value); setShowSuggestions(true); }}
                                onFocus={() => setShowSuggestions(true)}
                                onBlur={() => setTimeout(() => setShowSuggestions(false), 200)}
                            />
                        </div>
                    </div>
                    {showSuggestions && suggestions.length > 0 && (
                        <div className="absolute left-0 right-0 top-full mt-2 bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden z-50">
                            <ul className="custom-scroll max-h-48 overflow-y-auto">
                                {suggestions.map((item, idx) => (
                                    <li key={idx} onClick={() => onSelect(item)} className="px-5 py-3 text-sm font-medium cursor-pointer text-gray-600 hover:bg-teal-50 hover:text-teal-700">
                                        {item}
                                    </li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>
            );
        };

        const Toggle = ({ checked, onChange }) => (
            <button onClick={() => onChange(!checked)} className={`w-11 h-6 rounded-full transition-colors relative ${checked ? 'bg-[#00BFA5]' : 'bg-gray-200'}`}>
                <span className={`absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform ${checked ? 'translate-x-5' : 'translate-x-0'}`} />
            </button>
        );

        const App = () => {
            const [distanceDB, setDistanceDB] = useState([]);
            const [institutions, setInstitutions] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [dbSource, setDbSource] = useState('기본 데이터 (전남)');

            const [origin, setOrigin] = useState('');
            const [destination, setDestination] = useState('');
            const [distance, setDistance] = useState(0);
            const [shipFare, setShipFare] = useState(0);
            
            const [isFlipped, setIsFlipped] = useState(false);
            const [deductions, setDeductions] = useState({ gov_vehicle: false, meal_count: 0, is_intra: false });

            // 1. 내장 데이터 (전남 주요 거점 - 안전장치)
            const DEFAULT_JNE_DATA = [
                { 출발기관: "전남_본청", 도착기관: "전남_목포교육지원청", 편도거리_km: 7.2 },
                { 출발기관: "전남_본청", 도착기관: "전남_여수교육지원청", 편도거리_km: 151.4 },
                { 출발기관: "전남_본청", 도착기관: "전남_순천교육지원청", 편도거리_km: 108.3 },
                { 출발기관: "전남_본청", 도착기관: "전남_나주교육지원청", 편도거리_km: 48.7 },
                { 출발기관: "전남_본청", 도착기관: "전남_함평교육지원청", 편도거리_km: 38.5 },
                { 출발기관: "전남_본청", 도착기관: "전남_해남교육지원청", 편도거리_km: 42.1 },
                { 출발기관: "전남_본청", 도착기관: "전남_신안교육지원청", 편도거리_km: 12.5 }
            ];

            // 2. 데이터 로드 (오류 방지 로직 적용)
            useEffect(() => {
                // 우선 기본 데이터로 초기화하여 앱 실행 보장
                loadData(DEFAULT_JNE_DATA, '기본 데이터 (전남)');

                try {
                    // CSV 파일 자동 로드 시도
                    Papa.parse("Korea_Education_Distance_Matrix_Full_2026.csv", {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if(results.data && results.data.length > 0) {
                                loadData(results.data, '전국 통합 DB');
                            }
                        },
                        error: (err) => {
                            console.warn("CSV Auto-load failed. Please use manual upload.", err);
                            setIsLoading(false); 
                        }
                    });
                } catch (error) {
                    console.error("Critical PapaParse error:", error);
                    setIsLoading(false);
                }
            }, []);

            const loadData = (data, sourceName) => {
                setDistanceDB(data);
                const uniqueOffices = [...new Set([...data.map(i => i.출발기관), ...data.map(i => i.도착기관)])].filter(Boolean).sort();
                setInstitutions(uniqueOffices);
                setDbSource(sourceName);
                setIsLoading(false);
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsLoading(true);
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => loadData(results.data, '사용자 파일 DB')
                });
            };

            // 거리 자동 조회
            useEffect(() => {
                if (origin && destination && distanceDB.length > 0) {
                    const match = distanceDB.find(item => 
                        (item.출발기관 === origin && item.도착기관 === destination) ||
                        (item.출발기관 === destination && item.도착기관 === origin)
                    );
                    if (match) setDistance(parseFloat(match.편도거리_km));
                }
            }, [origin, destination, distanceDB]);

            // 비용 계산
            const calculateCosts = () => {
                const dist = parseFloat(distance) || 0;
                let oneWayTransport = 0;
                
                if (!deductions.is_intra) {
                    oneWayTransport = Math.round((CONFIG.BASE_FARE + (dist > 10 ? (dist - 10) * CONFIG.BUS_RATE : 0)) / 100) * 100;
                }

                let daily = deductions.is_intra ? (deductions.short_time ? CONFIG.IN_DAILY_SHORT : CONFIG.IN_DAILY_LONG) : CONFIG.OUT_DAILY;
                if (deductions.gov_vehicle) daily = deductions.is_intra ? daily - 10000 : daily / 2;

                let meal = 0;
                if (!deductions.is_intra) meal = CONFIG.OUT_MEAL - (deductions.meal_count * Math.floor(CONFIG.OUT_MEAL / 3));

                const totalTransport = (oneWayTransport * 2) + (shipFare || 0);
                const total = daily + meal + totalTransport;

                return { oneWayTransport, daily, meal, totalTransport, total };
            };

            const costs = calculateCosts();

            return (
                <div className="max-w-[480px] mx-auto min-h-screen flex flex-col p-5 bg-white relative">
                    {/* Header */}
                    <div className="text-center mt-6 mb-8">
                        <h1 className="text-2xl font-bold font-suit text-gray-900 tracking-tight">yeobi_easy for KOR</h1>
                        <div className="flex items-center justify-center gap-1.5 mt-2">
                            <span className="text-[10px] font-bold text-[#00BFA5] uppercase tracking-widest bg-teal-50 px-2 py-0.5 rounded-full">
                                {dbSource} 연결됨
                            </span>
                            <label className="cursor-pointer bg-gray-100 p-1 rounded-full hover:bg-gray-200 transition-colors" title="전국 데이터 파일(.csv) 불러오기">
                                <Icons.Upload />
                                <input type="file" className="hidden" accept=".csv" onChange={handleFileUpload} />
                            </label>
                        </div>
                    </div>

                    {/* Inputs */}
                    <div className="space-y-4 mb-6 z-20 relative">
                        <AutocompleteInput label="출발지" placeholder="예: 전남_본청" value={origin} onChange={setOrigin} onSelect={setOrigin} list={institutions} />
                        <AutocompleteInput label="도착지" placeholder="예: 전남_목포" value={destination} onChange={setDestination} onSelect={setDestination} list={institutions} />
                    </div>

                    {/* Flip Cards */}
                    <div className="perspective-1000 h-[450px] w-full relative z-10">
                        <div className={`flip-card-inner ${isFlipped ? 'is-flipped' : ''}`}>
                            
                            {/* FRONT: 교통비 계산창 */}
                            <div className="flip-card-front flex flex-col justify-between p-8 border border-gray-100 shadow-xl">
                                <div>
                                    <div className="flex justify-between items-start mb-6">
                                        <span className="text-sm font-bold text-teal-600 bg-teal-50 px-2 py-1 rounded-md">교통비 계산창</span>
                                        {shipFare > 0 && <span className="text-[10px] text-blue-500 font-bold bg-blue-50 px-2 py-1 rounded-md">+선박</span>}
                                    </div>
                                    
                                    {/* 요청: 화살표 밑에 거리 표시 */}
                                    <div className="flex items-center justify-center gap-3 mb-8">
                                        <span className="font-bold text-lg text-gray-900 truncate max-w-[80px]">{origin || '출발'}</span>
                                        <div className="flex flex-col items-center">
                                            <Icons.ArrowRight />
                                            <span className="text-[11px] font-bold text-teal-600 mt-1">{distance}km</span>
                                        </div>
                                        <span className="font-bold text-lg text-gray-900 truncate max-w-[80px]">{destination || '도착'}</span>
                                    </div>

                                    <div className="text-center py-6 border-t border-dashed border-gray-200">
                                        <p className="text-xs text-gray-400 mb-1">편도 교통비 (운임)</p>
                                        <h2 className="text-5xl font-black text-gray-900">{costs.oneWayTransport.toLocaleString()}<span className="text-xl font-medium ml-1 text-gray-400">원</span></h2>
                                    </div>
                                </div>
                                <button onClick={() => setIsFlipped(true)} className="w-full py-4 bg-[#00BFA5] text-white rounded-2xl font-bold text-sm shadow-lg shadow-teal-100 animate-pulse-attention active:scale-95 transition-transform">
                                    여비 계산 (일비/식비 포함)
                                </button>
                            </div>

                            {/* BACK: 여비 계산창 */}
                            <div className="flip-card-back p-6 border-2 border-[#00BFA5]/20 bg-white shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-gray-900 text-lg">여비 계산창</h3>
                                    <button onClick={() => setIsFlipped(false)} className="text-xs font-bold text-gray-400 hover:text-gray-600 flex items-center gap-1">
                                        <Icons.Refresh /> 뒤로
                                    </button>
                                </div>

                                <div className="space-y-4 mb-6">
                                    <div className="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                                        <span className="text-xs font-bold text-gray-600">관내 출장 (교통비 0원)</span>
                                        <Toggle checked={deductions.is_intra} onChange={() => setDeductions(p => ({...p, is_intra: !p.is_intra}))} />
                                    </div>
                                    <div className="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                                        <span className="text-xs font-bold text-gray-600">관용차량 이용</span>
                                        <Toggle checked={deductions.gov_vehicle} onChange={() => setDeductions(p => ({...p, gov_vehicle: !p.gov_vehicle}))} />
                                    </div>
                                    {!deductions.is_intra && (
                                        <div className="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                                            <span className="text-xs font-bold text-gray-600">식사 제공</span>
                                            <select className="text-xs font-bold bg-transparent outline-none text-right text-teal-600" value={deductions.meal_count} onChange={(e) => setDeductions(p => ({...p, meal_count: parseInt(e.target.value)}))}>
                                                <option value="0">없음</option><option value="1">1식</option><option value="2">2식</option><option value="3">3식</option>
                                            </select>
                                        </div>
                                    )}
                                    <div className="flex justify-between items-center p-3 bg-gray-50 rounded-xl">
                                        <span className="text-xs font-bold text-gray-600">기타교통비</span>
                                        <div className="flex items-center gap-1">
                                            <input type="number" value={shipFare || ''} onChange={(e) => setShipFare(parseInt(e.target.value) || 0)} placeholder="0" className="ship-fare-input" />
                                            <span className="text-xs font-bold text-gray-400">원</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-2 pt-2 border-t border-gray-100">
                                    <div className="flex justify-between text-xs text-gray-500"><span>일비</span><span>{costs.daily.toLocaleString()}원</span></div>
                                    <div className="flex justify-between text-xs text-gray-500"><span>식비</span><span>{costs.meal.toLocaleString()}원</span></div>
                                    <div className="flex justify-between text-xs text-gray-500"><span>교통비(왕복)</span><span>{costs.totalTransport.toLocaleString()}원</span></div>
                                    <div className="flex justify-between items-center pt-4 mt-2 border-t border-teal-100">
                                        <span className="font-bold text-gray-900">총 지급액</span>
                                        <span className="font-black text-2xl text-[#00BFA5]">{costs.total.toLocaleString()}<span className="text-sm font-medium text-gray-400 ml-1">원</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <footer className="mt-auto pt-6 text-center">
                        <p className="text-[10px] text-gray-300 font-bold font-pretendard">crafted with passion by 전현우<br/>Based on 2026 JNE Guidelines</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
